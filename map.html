<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×” ××™× ×˜×¨××§×˜×™×‘×™×ª - ××¤×ª ×•× ×§×•×‘×¨ ×œ×™×œ×“×™×</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0060A9">
  <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .station:hover{transform:scale(1.12)}
    .taparea{cursor:pointer}
    .svg-wrap{min-width:850px}
    @media (max-width: 640px){ .svg-wrap{min-width:700px} }
    #schemaSvg { touch-action: pan-x pinch-zoom; }
    /* ×ª×•×•×™×•×ª */
    .station-label{ font-size:11px; fill:#111827; font-weight:600; }
    .label-bg{ fill:#fff; stroke:#e5e7eb; stroke-width:1; rx:3 }
    /* ×ª×—× ×•×ª ×—×™×‘×•×¨ */
    .transfer-station{ cursor:pointer; }
    .transfer-station:hover .station{ transform:scale(1.15); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">

  <!-- ×›×•×ª×¨×ª ×¢× ×›×¤×ª×•×¨ ×—×–×¨×” -->
  <header class="bg-white shadow p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button onclick="goHome()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
          ğŸ  <span>×—×–×¨×” ×œ×¢××•×“ ×”×¨××©×™</span>
        </button>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">×”××¤×” ×”××™× ×˜×¨××§×˜×™×‘×™×ª</h1>
          <p class="text-sm text-gray-600">×œ×—×¥ ×¢×œ ×ª×—× ×” ×œ××™×“×¢ ××¤×•×¨×˜</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="goToCalculator()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
          ğŸ§­ ××—×©×‘×•×Ÿ ××¡×œ×•×œ×™×
        </button>
        <div id="offlineBadge" class="hidden bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
          ×¤×•×¢×œ ×‘××¦×‘ ×œ× ××§×•×•×Ÿ
        </div>
      </div>
    </div>
  </header>

  <main class="p-4">
    <!-- ×¡×›××” ××™× ×˜×¨××§×˜×™×‘×™×ª -->
    <section class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 mt-6">
      <div class="mb-4 text-center">
        <h2 class="text-xl font-bold text-gray-800 mb-2">×¡×›××” ××™× ×˜×¨××§×˜×™×‘×™×ª ×©×œ ×§×•×•×™ ×”×¡×§×™×™×˜×¨×™×™×Ÿ</h2>
        <p class="text-gray-600">×œ×—×™×¦×” ×¢×œ ×ª×—× ×” ×ª×¤×ª×— ××™×“×¢. ×”×¦×‘×¢×™×: ××§×¡×¤×• â€” ×›×—×•×œ, ××™×œ× ×™×•× â€” ×¦×”×•×‘, ×§× ×“×” â€” ×ª×›×œ×ª.</p>
      </div>

      <div class="overflow-auto">
        <svg id="schemaSvg" class="svg-wrap w-full h-auto" viewBox="0 0 820 1400" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="820" height="1400" fill="url(#bg)"/>
          <defs>
            <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#EFF6FF"/>
              <stop offset="100%" stop-color="#ECFEFF"/>
            </linearGradient>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity=".15"/>
            </filter>
          </defs>

          <g id="paths"></g>
          <g id="stations"></g>

          <!-- ××§×¨× -->
          <g id="legend" transform="translate(520,20)" filter="url(#shadow)">
            <rect width="180" height="110" rx="12" fill="#fff" stroke="#e5e7eb"/>
            <g transform="translate(20,20)">
              <!-- ×©×•×¨×” 1 -->
              <text x="80" y="10" font-size="13" fill="#111827" text-anchor="end">×§×• ××§×¡×¤×•</text>
              <circle r="7" cx="150" cy="6" fill="#0060A9"/>
              <!-- ×©×•×¨×” 2 -->
              <text x="70" y="40" font-size="13" fill="#111827" text-anchor="end">×§×• ×”××™×œ× ×™×•×</text>
              <circle r="7" cx="150" cy="36" fill="#ffcd00"/>
              <!-- ×©×•×¨×” 3 -->
              <text x="90" y="70" font-size="13" fill="#111827" text-anchor="end">×§×• ×§× ×“×”</text>
              <circle r="7" cx="150" cy="66" fill="#009AC8"/>
            </g>
          </g>
        </svg>
      </div>
    </section>

    <!-- ×¨×©×™××•×ª ×ª×—× ×•×ª ×œ×¤×™ ×§×• - ××¢×•×“×›×Ÿ ×œ×ª×™×§×•×Ÿ 2 -->
    <section class="px-0 pb-8 mt-6">
      <div class="max-w-6xl mx-auto space-y-6" id="linesContainer"></div>
    </section>
  </main>

  <!-- ××•×“×œ ××™×“×¢ ×ª×—× ×” -->
  <div id="stationModal" class="fixed inset-0 bg-black/50 items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-auto">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">××™×“×¢ ×¢×œ ×”×ª×—× ×”</h3>
          <button onclick="closeStationInfo()" class="text-gray-500 hover:text-gray-700 text-2xl" aria-label="×¡×’×•×¨">Ã—</button>
        </div>
        <div class="space-y-4" id="stationContent"></div>
      </div>
    </div>
  </div>

  <footer class="bg-gray-800 text-white p-6">
    <div class="max-w-6xl mx-auto text-center">
      <h3 class="text-lg font-bold mb-2">××•×“×•×ª ×”××¤×œ×™×§×¦×™×”</h3>
      <p class="text-gray-300 text-sm mb-4">××¤×œ×™×§×¦×™×” ×—×™× ××™×ª ×œ×™×œ×“×™× ×œ×œ×™××•×“ ××¢×¨×›×ª ×”×¡×§×™×™×˜×¨×™×™×Ÿ. ×›×œ ×”××™×“×¢ × ×©××¨ ××§×•××™×ª.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div class="bg-gray-700 p-3 rounded-lg"><h4 class="font-medium mb-1">3 ×§×•×•×™×</h4><p class="text-gray-400">××§×¡×¤×•, ××™×œ× ×™×•×, ×§× ×“×”</p></div>
        <div class="bg-gray-700 p-3 rounded-lg"><h4 class="font-medium mb-1">54 ×ª×—× ×•×ª</h4><p class="text-gray-400">×‘×›×œ ×”××˜×¨×•×¤×•×œ×™×Ÿ</p></div>
        <div class="bg-gray-700 p-3 rounded-lg"><h4 class="font-medium mb-1">×¨×›×‘×ª ××•×˜×•××˜×™×ª</h4><p class="text-gray-400">×œ×œ× × ×”×’</p></div>
      </div>
      <div class="mt-6 pt-4 border-t border-gray-600">
        <p class="text-xs text-gray-400">× ×ª×•× ×™× ×œ×©× ×ª 2025 â€¢ ××§×•×¨: TransLink</p>
      </div>
    </div>
  </footer>

  <script>
    /* Navigation functions */
    function goHome() {
      window.location.href = './index.html';
    }
    
    function goToCalculator() {
      window.location.href = './calculator.html';
    }

    /* Service Worker registration */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
    }

    /* Offline badge */
    function updateOfflineBadge(){
      const b = document.getElementById('offlineBadge');
      if (!navigator.onLine) {
        b.classList.remove('hidden');
      } else {
        b.classList.add('hidden');
      }
    }
    window.addEventListener('online', updateOfflineBadge);
    window.addEventListener('offline', updateOfflineBadge);
    updateOfflineBadge();

    /* Data: lines & stations - ××¢×•×“×›×Ÿ ×¢× ×§×•×•×™× ××¨×•×‘×™× */
    const lines = {
      expo: {
        nameHe:'×§×• ××§×¡×¤×•', nameEn:'Expo Line', color:'#0060A9',
        stations:[
          {id:'waterfront',nameHe:'×•×•×˜×¨×¤×¨×•× ×˜',nameEn:'Waterfront',zone:1,platforms:2,accessibility:true,transfers:['canada','seabus','westcoast']},
          {id:'burrard',nameHe:'×‘×•×¨×¨×“',nameEn:'Burrard',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'granville',nameHe:'×’×¨× ×•×•×™×œ',nameEn:'Granville',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'stadium',nameHe:'××™×¦×˜×“×™×•×Ÿ-×¦\'×™×™× ×˜××•×Ÿ',nameEn:'Stadiumâ€“Chinatown',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'main-street',nameHe:'××™×™×Ÿ ×¡×˜×¨×™×˜-×××˜××•×Ÿ',nameEn:'Main Streetâ€“Science World',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'commercial',nameHe:'×§×•××¨×©×™××œ-×‘×¨×•×“×•×•×™×™',nameEn:'Commercialâ€“Broadway',zone:1,platforms:2,accessibility:true,transfers:['millennium']},
          {id:'nanaimo',nameHe:'× × ××™××•',nameEn:'Nanaimo',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'29th-ave',nameHe:'×©×“×¨×” 29',nameEn:'29th Avenue',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'joyce',nameHe:'×’\'×•×™×¡-×§×•×œ×™× ×’×•×•×“',nameEn:'Joyceâ€“Collingwood',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'patterson',nameHe:'×¤×˜×¨×¡×•×Ÿ',nameEn:'Patterson',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'metrotown',nameHe:'××˜×¨×•×˜××•×Ÿ',nameEn:'Metrotown',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'royal-oak',nameHe:'×¨×•×™××œ ××•×§',nameEn:'Royal Oak',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'edmonds',nameHe:'××“××•× ×“×¡',nameEn:'Edmonds',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'22nd-street',nameHe:'×¨×—×•×‘ 22',nameEn:'22nd Street',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'new-west',nameHe:'× ×™×• ×•×•×¡×˜××™× ×¡×˜×¨',nameEn:'New Westminster',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'columbia',nameHe:'×§×•×œ×•××‘×™×”',nameEn:'Columbia',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'scott-road',nameHe:'×“×¨×š ×¡×§×•×˜',nameEn:'Scott Road',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'gateway',nameHe:'×’×™×™×˜×•×•×™×™',nameEn:'Gateway',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'surrey-central',nameHe:'××¨×›×– ×¡××¨×™',nameEn:'Surrey Central',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'king-george',nameHe:'×§×™× ×’ ×’\'×•×¨×’\'',nameEn:'King George',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'sapperton',nameHe:'×¡××¤×¨×˜×•×Ÿ',nameEn:'Sapperton',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'braid',nameHe:'×‘×¨×™×™×“',nameEn:'Braid',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'lougheed',nameHe:'×œ××•×”×™×“',nameEn:'Lougheed Town Centre',zone:2,platforms:2,accessibility:true,transfers:['millennium']},
          {id:'production-way',nameHe:'×¤×¨×•×“×§×©×Ÿ ×•×•×™×™',nameEn:'Production Wayâ€“University',zone:2,platforms:2,accessibility:true,transfers:['millennium']}
        ]
      },
      millennium: {
        nameHe:'×§×• ×”××™×œ× ×™×•×', nameEn:'Millennium Line', color:'#FED100',
        stations:[
          {id:'vcc-clark',nameHe:'VCC-×§×œ××¨×§',nameEn:'VCCâ€“Clark',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'commercial',nameHe:'×§×•××¨×©×™××œ-×‘×¨×•×“×•×•×™×™',nameEn:'Commercialâ€“Broadway',zone:1,platforms:2,accessibility:true,transfers:['expo']},
          {id:'renfrew',nameHe:'×¨× ×¤×¨×•',nameEn:'Renfrew',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'rupert',nameHe:'×¨×•×¤×¨×˜',nameEn:'Rupert',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'gilmore',nameHe:'×’×™×œ××•×¨',nameEn:'Gilmore',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'brentwood',nameHe:'×‘×¨× ×˜×•×•×“',nameEn:'Brentwood Town Centre',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'holdom',nameHe:'×”×•×œ×“×•×',nameEn:'Holdom',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'sperling',nameHe:'×¡×¤×¨×œ×™× ×’',nameEn:'Sperlingâ€“Burnaby Lake',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'lake-city-way',nameHe:'×“×¨×š ×¢×™×¨ ×”××’×',nameEn:'Lake City Way',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'production-way',nameHe:'×¤×¨×•×“×§×©×Ÿ ×•×•×™×™',nameEn:'Production Wayâ€“University',zone:2,platforms:2,accessibility:true,transfers:['expo']},
          {id:'lougheed',nameHe:'×œ××•×”×™×“',nameEn:'Lougheed Town Centre',zone:2,platforms:2,accessibility:true,transfers:['expo']},
          {id:'burquitlam',nameHe:'×‘×¨×§×™×˜×œ×',nameEn:'Burquitlam',zone:3,platforms:2,accessibility:true,transfers:[]},
          {id:'moody-centre',nameHe:'××¨×›×– ××•×“×™',nameEn:'Moody Centre',zone:3,platforms:2,accessibility:true,transfers:[]},
          {id:'inlet-centre',nameHe:'××¨×›×– ××™× ×œ×˜',nameEn:'Inlet Centre',zone:3,platforms:2,accessibility:true,transfers:[]},
          {id:'coquitlam-central',nameHe:'××¨×›×– ×§×•×§×™×˜×œ×',nameEn:'Coquitlam Central',zone:3,platforms:2,accessibility:true,transfers:[]},
          {id:'lincoln',nameHe:'×œ×™× ×§×•×œ×Ÿ',nameEn:'Lincoln',zone:3,platforms:2,accessibility:true,transfers:[]},
          {id:'lafarge-lake',nameHe:'××’× ×œ××¤××¨×’\'',nameEn:'Lafarge Lakeâ€“Douglas',zone:3,platforms:2,accessibility:true,transfers:[]}
        ]
      },
      canada: {
        nameHe:'×§×• ×§× ×“×”', nameEn:'Canada Line', color:'#009AC8',
        stations:[
          {id:'waterfront',nameHe:'×•×•×˜×¨×¤×¨×•× ×˜',nameEn:'Waterfront',zone:1,platforms:2,accessibility:true,transfers:['expo','seabus','westcoast']},
          {id:'vancouver-city-centre',nameHe:'××¨×›×– ×”×¢×™×¨ ×•× ×§×•×‘×¨',nameEn:'Vancouver City Centre',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'yaletown',nameHe:'×™×™×œ×˜××•×Ÿ',nameEn:'Yaletownâ€“Roundhouse',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'olympic-village',nameHe:'×”×›×¤×¨ ×”××•×œ×™××¤×™',nameEn:'Olympic Village',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'broadway-city-hall',nameHe:'×‘×¨×•×“×•×•×™×™-×¢×™×¨×™×™×ª ×”×¢×™×¨',nameEn:'Broadwayâ€“City Hall',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'king-edward',nameHe:'×§×™× ×’ ××“×•××¨×“',nameEn:'King Edward',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'oakridge',nameHe:'××•×§×¨×™×“×’\'',nameEn:'Oakridgeâ€“41st Avenue',zone:1,platforms:2,accessibility:true,transfers:[]},
          {id:'langara',nameHe:'×œ× ×’×¨×”',nameEn:'Langaraâ€“49th Avenue',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'marine-drive',nameHe:'×“×¨×™×™×‘ ×™××™',nameEn:'Marine Drive',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'bridgeport',nameHe:'×‘×¨×™×“×’\'×¤×•×¨×˜',nameEn:'Bridgeport',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'templeton',nameHe:'×˜××¤×œ×˜×•×Ÿ',nameEn:'Templeton',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'sea-island-centre',nameHe:'××¨×›×– ××™ ×”×™×',nameEn:'Sea Island Centre',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'yvr-airport',nameHe:'× ××œ ×ª×¢×•×¤×” YVR',nameEn:'YVRâ€“Airport',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'aberdeen',nameHe:'××‘×¨×“×™×Ÿ',nameEn:'Aberdeen',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'lansdowne',nameHe:'×œ× ×¡×“××•×Ÿ',nameEn:'Lansdowne',zone:2,platforms:2,accessibility:true,transfers:[]},
          {id:'richmond-brighouse',nameHe:'×¨×™×¦\'××•× ×“-×‘×¨×™×’×”××•×¡',nameEn:'Richmond-Brighouse',zone:2,platforms:2,accessibility:true,transfers:[]}
        ]
      }
    };

    const transferTypeMap = {
      'canada': '×§×• ×§× ×“×”',
      'expo': '×§×• ××§×¡×¤×•', 
      'millennium': '×§×• ×”××™×œ× ×™×•×',
      'seabus': '××¢×‘×•×¨×ª ×™××™×ª',
      'westcoast': '×¨×›×‘×ª ×—×•×£ ××¢×¨×‘×™'
    };

    /* ===== ×¨×©×™××ª ×ª×—× ×•×ª ×œ×¤×™ ×§×• - ×ª×™×§×•×Ÿ 2: ×ª×—× ×•×ª ×‘×©× ×™ ×§×•×•×™× ×ª×•×¤×¢× ×” ×¤×¢××™×™× ===== */
    function renderLines() {
      const container = document.getElementById('linesContainer');
      
      // ×™×¦×™×¨×ª ××¢×¨×š ×©×œ ×›×œ ×”×ª×—× ×•×ª ×¢× ×”×§×•×•×™× ×©×œ×”×Ÿ
      const stationsWithLines = new Map();
      
      Object.entries(lines).forEach(([lineKey, lineData]) => {
        lineData.stations.forEach(station => {
          if (!stationsWithLines.has(station.id)) {
            stationsWithLines.set(station.id, {
              ...station,
              lines: []
            });
          }
          
          const stationData = stationsWithLines.get(station.id);
          stationData.lines.push({
            key: lineKey,
            nameHe: lineData.nameHe,
            nameEn: lineData.nameEn,
            color: lineData.color
          });
        });
      });
      
      Object.entries(lines).forEach(([lineKey, lineData]) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'bg-white rounded-xl shadow-lg overflow-hidden';
        
        lineDiv.innerHTML = `
          <div class="p-4" style="background-color: ${lineData.color}; color: white;">
            <h3 class="text-xl font-bold">${lineData.nameHe}</h3>
            <p class="text-sm opacity-90">${lineData.nameEn} â€¢ ${lineData.stations.length} ×ª×—× ×•×ª</p>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="stations-${lineKey}"></div>
          </div>
        `;
        
        container.appendChild(lineDiv);
        
        const grid = document.getElementById(`stations-${lineKey}`);
        lineData.stations.forEach(st => {
          const stationData = stationsWithLines.get(st.id);
          const btn = document.createElement('button');
          btn.className = 'text-right p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 transition-colors';
          
          // ×ª×™×§×•×Ÿ 1: ×”×¦×’×ª ×§×•×•×™ ×”××•×˜×•×‘×•×¡ ×©×¢×•×‘×¨×™× ×‘×ª×—× ×”
          const linesInfo = stationData.lines.map(line => 
            `<span class="inline-flex items-center gap-1">
              <span class="w-3 h-3 rounded-full" style="background-color: ${line.color}"></span>
              <span class="text-xs">${line.nameHe}</span>
            </span>`
          ).join(' ');
          
          btn.innerHTML = `
            <div class="font-medium text-gray-800">${st.nameHe}</div>
            <div class="text-sm text-gray-600">${st.nameEn}</div>
            <div class="text-xs text-gray-500 mt-1">
              ××–×•×¨ ${st.zone} â€¢ ${st.platforms} ×¨×¦×™×¤×™×
              ${st.accessibility ? '<span class="text-xs text-green-700">â™¿ï¸</span>' : ''}
            </div>
            <div class="text-xs mt-1">
              ×§×•×•×™×: ${linesInfo}
            </div>
            ${st.busLines && st.busLines.length ? `<div class="text-xs mt-1 text-orange-600">
              ××•×˜×•×‘×•×¡×™×: ${st.busLines.slice(0, 2).join(', ')}${st.busLines.length > 2 ? ` +${st.busLines.length - 2}` : ''}
            </div>` : ''}`;
          btn.addEventListener('click',() => handleStationClick(st.id));
          grid.appendChild(btn);
        });
      });
    }

    /* ===== ××•×“×œ ×ª×—× ×” - ×ª×™×§×•×Ÿ 1,2,3: ×”×¦×’×ª ×§×•×•×™× ×”×¢×•×‘×¨×™× ×‘×ª×—× ×” ×•×§×•×•×™ ××•×˜×•×‘×•×¡ ===== */
    function getStationInfo(stationId){
      // ×™×¦×™×¨×ª ××¢×¨×š ×©×œ ×›×œ ×”×§×•×•×™× ×©×¢×•×‘×¨×™× ×‘×ª×—× ×”
      const stationLines = [];
      let stationData = {};
      let busLines = [];
      
      Object.entries(lines).forEach(([lineKey, lineData]) => {
        const station = lineData.stations.find(s => s.id === stationId);
        if (station) {
          if (!stationData.nameHe) {
            Object.assign(stationData, station);
            busLines = station.busLines || [];
          }
          stationLines.push({
            key: lineKey,
            nameHe: lineData.nameHe,
            nameEn: lineData.nameEn,
            color: lineData.color
          });
        }
      });
      
      if (stationLines.length > 0) {
        return { ...stationData, lines: stationLines, busLines: busLines };
      }
      
      return null;
    }

    const stationModal = document.getElementById('stationModal');
    const stationContent = document.getElementById('stationContent');

    function handleStationClick(stationId){
      const st = getStationInfo(stationId);
      if (!st) return;
      
      stationContent.innerHTML = `
        <div><h4 class="font-bold text-lg text-gray-800 mb-1">${st.nameHe}</h4><p class="text-gray-600">${st.nameEn}</p></div>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-blue-50 p-3 rounded-lg"><div class="mb-1 text-sm font-medium text-blue-800">××–×•×¨ ×ª×¢×¨×™×£</div><p class="text-xl font-bold text-blue-600">××–×•×¨ ${st.zone}</p></div>
          <div class="bg-green-50 p-3 rounded-lg"><div class="mb-1 text-sm font-medium text-green-800">×¨×¦×™×¤×™×</div><p class="text-xl font-bold text-green-600">${st.platforms}</p></div>
        </div>
        <div>
          <h5 class="font-medium text-gray-800 mb-2">×§×•×•×™× ×”×¢×•×‘×¨×™× ×‘×ª×—× ×”:</h5>
          <div class="space-y-2">
            ${st.lines.map(l=>`<div class="flex items-center gap-3 p-2 bg-gray-50 rounded">
              <span class="w-4 h-4 rounded-full inline-block" style="background:${l.color}"></span>
              <span class="font-medium">${l.nameHe}</span><span class="text-sm text-gray-600">(${l.nameEn})</span>
            </div>`).join('')}
          </div>
        </div>
        ${st.transfers && st.transfers.length?`<div><h5 class="font-medium text-gray-800 mb-2">×—×™×‘×•×¨×™×:</h5>
          <div class="flex flex-wrap gap-2">${st.transfers.map(t=>`<span class="text-sm text-blue-700 bg-blue-50 px-2 py-1 rounded">${transferTypeMap[t]||t}</span>`).join('')}</div></div>`:''}
        <div class="flex items-center gap-2 ${st.accessibility?'text-green-600':'text-red-600'}"><span>â™¿ï¸</span>
          <span class="text-sm font-medium">${st.accessibility?'× ×’×™×© ×œ×›×™×¡××•×ª ×’×œ×’×œ×™×':'×œ× × ×’×™×©'}</span></div>
        <div class="bg-yellow-50 p-3 rounded-lg"><div class="mb-1 text-sm font-medium text-yellow-800">××™×“×¢ ×›×œ×œ×™</div>
          <p class="text-xs text-yellow-700">×”×¡×§×™×™×˜×¨×™×™×Ÿ ×¤×•×¢×œ ×‘×§×™×¨×•×‘ 05:00â€“01:30 (×©×³ ~06:00, ××³/×—×’×™× ~07:00â€“00:30). ×ª×“×™×¨×•×ª ~2â€“7 ×“×§×³ ×‘×©×¢×•×ª ×”×¢×•××¡.</p></div>`;
      stationModal.classList.remove('hidden'); 
      stationModal.classList.add('flex');
    }

    function closeStationInfo(){
      stationModal.classList.add('hidden'); 
      stationModal.classList.remove('flex');
    }
    window.closeStationInfo = closeStationInfo;

    /* ===== ×¦×™×•×¨ ×”-SVG ×”××ª×•×§×Ÿ ===== */
    const svg = document.getElementById('schemaSvg');
    const gPaths = document.getElementById('paths');
    const gStations = document.getElementById('stations');

    const X = { canadaMain:210, canadaAir:170, canadaRich:250, expoMain:410, expoBranch:520, millennium:630 };
    const yStart = 100, yStep = 56;
    const row = {};
    
    // ×”×’×“×¨×ª ×ª×—× ×•×ª ×œ×¤×™ ×©×•×¨×•×ª
    const expoMain = ['waterfront','burrard','granville','stadium','main-street','commercial','nanaimo','29th-ave','joyce','patterson','metrotown','royal-oak','edmonds','22nd-street','new-west','columbia','scott-road','gateway','surrey-central','king-george'];
    expoMain.forEach((id,i) => row[id] = i);
    ['sapperton','braid','lougheed','production-way'].forEach((id,i) => row[id] = row['columbia']+1+i);
    
    const canadaMain = ['waterfront','vancouver-city-centre','yaletown','olympic-village','broadway-city-hall','king-edward','oakridge','langara','marine-drive','bridgeport'];
    canadaMain.forEach((id,i) => row[id] = Math.min(row[id]??Infinity, i));
    
    const canadaAir = ['templeton','sea-island-centre','yvr-airport'];
    canadaAir.forEach((id,i) => row[id] = row['bridgeport']+1+i);
    
    const canadaRich = ['aberdeen','lansdowne','richmond-brighouse'];
    canadaRich.forEach((id,i) => row[id] = row['bridgeport']+1+i);
    
    const milli = ['vcc-clark','commercial','renfrew','rupert','gilmore','brentwood','holdom','sperling','lake-city-way','production-way','lougheed','burquitlam','moody-centre','inlet-centre','coquitlam-central','lincoln','lafarge-lake'];
    const mStart = row['commercial'] - 1;
    milli.forEach((id,i) => row[id] = row[id]??(mStart+i));

    const Y = r => yStart + r*yStep;

    function addPath(points,color){
      if(points.length<2) return;
      const d = points.map((p,i)=> (i?'L':'M')+p.x+' '+p.y ).join(' ');
      const pth = document.createElementNS('http://www.w3.org/2000/svg','path');
      pth.setAttribute('d', d);
      pth.setAttribute('stroke', color);
      pth.setAttribute('stroke-width', 6);
      pth.setAttribute('fill','none');
      pth.setAttribute('stroke-linecap','round');
      pth.setAttribute('stroke-linejoin','round');
      gPaths.appendChild(pth);
    }

    function link(a,b){
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d',`M ${a.x} ${a.y} L ${b.x} ${b.y}`);
      p.setAttribute('stroke','#111827'); 
      p.setAttribute('stroke-width','2'); 
      p.setAttribute('stroke-dasharray','4 4'); 
      p.setAttribute('opacity','0.35');
      gPaths.appendChild(p);
    }

    function findLabel(id){
      for(const l of Object.values(lines)){
        const s = l.stations.find(s => s.id === id);
        if(s) return s.nameHe || s.nameEn;
      }
      return id;
    }

    // ×¤×•× ×§×¦×™×” ×—×“×©×”: ×™×¦×™×¨×ª ××¢×¨×š ×ª×—× ×•×ª ×™×™×—×•×“×™×•×ª
    function createUniqueStationsMap() {
      const uniqueStations = new Map();
      
      Object.entries(lines).forEach(([lineKey, lineData]) => {
        lineData.stations.forEach(station => {
          if (!uniqueStations.has(station.id)) {
            uniqueStations.set(station.id, {
              id: station.id,
              nameHe: station.nameHe,
              nameEn: station.nameEn,
              lines: []
            });
          }
          
          const stationData = uniqueStations.get(station.id);
          stationData.lines.push({
            key: lineKey,
            color: lineData.color,
            name: lineData.nameHe
          });
        });
      });
      
      return uniqueStations;
    }

function addStationUnique(x, y, id, linesData, label, preferred = 'right') {
  const NS = 'http://www.w3.org/2000/svg';
  const g = document.createElementNS(NS, 'g');
  g.classList.add('taparea');
  // × ×¦×¨×£ ××™×“ ×œ-DOM (××•×¡×ª×¨ ×–×× ×™×ª) ×›×“×™ ×©××“×™×“×•×ª getBBox ×™×”×™×• ××“×•×™×§×•×ª
  g.setAttribute('visibility', 'hidden');
  gStations.appendChild(g);

  const isTransfer = linesData.length > 1;

  // ---- ×¦×™×•×¨ ×”×ª×—× ×” ----
  if (isTransfer) {
    const outer = document.createElementNS(NS, 'circle');
    outer.setAttribute('cx', x); outer.setAttribute('cy', y);
    outer.setAttribute('r', 10); outer.setAttribute('fill', '#fff');
    outer.setAttribute('stroke', '#333'); outer.setAttribute('stroke-width', 2);
    outer.classList.add('station');
    g.appendChild(outer);

    linesData.forEach((ln, i) => {
      const ang = (2*Math.PI*i)/linesData.length, r = 5;
      const c = document.createElementNS(NS, 'circle');
      c.setAttribute('cx', x + Math.cos(ang)*r);
      c.setAttribute('cy', y + Math.sin(ang)*r);
      c.setAttribute('r', 3); c.setAttribute('fill', ln.color);
      g.appendChild(c);
    });
  } else {
    const c = document.createElementNS(NS, 'circle');
    c.setAttribute('cx', x); c.setAttribute('cy', y);
    c.setAttribute('r', 7);
    c.setAttribute('fill', linesData[0].color);
    c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width', 2);
    c.classList.add('station');
    g.appendChild(c);
  }

  // ---- ×ª×•×•×™×ª: ××“×™×“×” ×•××™×§×•× ----
  const padding = 6;
  const sideOffset = 22;   // ××¨×•×•×— ××•×¤×§×™ ××”×¢×™×’×•×œ
  const topOffset  = 18;   // ××¨×•×•×— ×× ×›×™ ××¢×œ ×”×¢×™×’×•×œ (×œ×ª×—× ×•×ª ×—×™×‘×•×¨)
  const mode = isTransfer ? 'top' : (preferred === 'left' ? 'left' : 'right');

  const t = document.createElementNS(NS, 'text');
  t.classList.add('station-label');
  t.textContent = label;
  // ××’×“×™×¨×™× RTL ××‘×œ ××¢×’× ×™× ×‘××¨×›×– ×›×“×™ ×©×”×˜×§×¡×˜ ×™×”×™×” ×××•×¨×›×– ×‘××“×•×™×§
  t.setAttribute('direction', 'rtl');
  t.setAttribute('unicode-bidi', 'plaintext');
  t.setAttribute('text-anchor', 'middle');
  t.setAttribute('dominant-baseline', 'middle');
  t.setAttribute('pointer-events', 'none');
  // ××™×§×•× ×–×× ×™ (×™×¢×•×“×›×Ÿ ××—×¨×™ ××“×™×“×”)
  t.setAttribute('x', x);
  t.setAttribute('y', y);
  g.appendChild(t);

  // ××“×™×“×” ×××™×ª×™×ª â€“ ×¢×›×©×™×• ×›×©×”×˜×§×¡×˜ ×‘-DOM
  const bb = t.getBBox();
  const w = Math.max(60, Math.ceil(bb.width)  + 2*padding);
  const h = Math.max(18, Math.ceil(bb.height) + 2*padding);

  // ×—×™×©×•×‘ ××™×§×•× ×”××œ×‘×Ÿ ×œ×¤×™ ××¦×‘
  let rx, ry;
  if (mode === 'right') {
    rx = (x + sideOffset) - padding;
    ry = y - h/2;
  } else if (mode === 'left') {
    rx = (x - sideOffset) - (w - padding);
    ry = y - h/2;
  } else { // top
    rx = x - w/2;
    ry = (y - 10) - topOffset - h/2; // 10 = ×¨×“×™×•×¡ ×ª×—× ×ª ×—×™×‘×•×¨
  }

  const r = document.createElementNS(NS, 'rect');
  r.setAttribute('x', rx);
  r.setAttribute('y', ry);
  r.setAttribute('width',  w);
  r.setAttribute('height', h);
  r.setAttribute('rx', 6);
  r.setAttribute('fill', '#fff');
  r.setAttribute('stroke', '#e5e7eb');
  r.setAttribute('stroke-width', 1);
  r.setAttribute('pointer-events', 'none');

  // ××œ×‘×Ÿ ××ª×—×ª ×œ×˜×§×¡×˜
  g.insertBefore(r, t);

  // ××¨×›×–×™× ××ª ×”×˜×§×¡×˜ ×‘×ª×•×š ×”××œ×‘×Ÿ
  t.setAttribute('x', rx + w/2);
  t.setAttribute('y', ry + h/2);

  // ×—×©×™×¤×” ×•×§×œ×™×§
  g.setAttribute('visibility', 'visible');
  g.addEventListener('click', () => handleStationClick(id));
}

    function drawUniqueStations() {
      const uniqueStations = createUniqueStationsMap();
      
      const stationPositions = {
        // ×ª×—× ×•×ª ×§×• ×§× ×“×” - ×¦×™×¨ ×¨××©×™
        ...canadaMain.reduce((acc, id) => {
          acc[id] = { x: X.canadaMain, y: Y(row[id]), labelSide: 'left' };
          return acc;
        }, {}),
   
        // ×ª×—× ×•×ª ×§×• ×§× ×“×” - × ××œ ×ª×¢×•×¤×”
        ...canadaAir.reduce((acc, id) => {
          acc[id] = { x: X.canadaAir, y: Y(row[id]), labelSide: 'left' };
          return acc;
        }, {}),
   
        // ×ª×—× ×•×ª ×§×• ×§× ×“×” - ×¨×™×¦'××•× ×“
        ...canadaRich.reduce((acc, id) => {
          acc[id] = { x: X.canadaRich, y: Y(row[id]), labelSide: 'right' };
          return acc;
        }, {}),
        
        // ×ª×—× ×•×ª ××§×¡×¤×• - ×¦×™×¨ ×¨××©×™
        ...expoMain.reduce((acc, id) => {
          acc[id] = { x: X.expoMain, y: Y(row[id]), labelSide: 'right' };
          return acc;
        }, {}),
        
        // ×ª×—× ×•×ª ××§×¡×¤×• - ×”×¡×ª×¢×¤×•×ª
        ...['sapperton','braid','lougheed','production-way'].reduce((acc, id) => {
          acc[id] = { x: X.expoBranch, y: Y(row[id]), labelSide: 'left' };
          return acc;
        }, {}),
        
        // ×ª×—× ×•×ª ××™×œ× ×™×•×
        ...milli.reduce((acc, id) => {
          acc[id] = { x: X.millennium, y: Y(row[id]), labelSide: 'right' };
          return acc;
        }, {})
      };
      
      // ××™×§×•××™× ××™×•×—×“×™× ×œ×ª×—× ×•×ª ×—×™×‘×•×¨
      const specialPositions = {
  'waterfront':     { x: (X.canadaMain + X.expoMain) / 2, y: Y(row['waterfront']),     labelSide: 'top' },
  'commercial':     { x: (X.expoMain   + X.millennium) / 2, y: Y(row['commercial']),    labelSide: 'top' },
  'lougheed':       { x: (X.expoBranch + X.millennium) / 2, y: Y(row['lougheed']),      labelSide: 'top' },
  'production-way': { x: (X.expoBranch + X.millennium) / 2, y: Y(row['production-way']),labelSide: 'top' }
};
      
      // ×¦×™×•×¨ ×”×ª×—× ×•×ª
      uniqueStations.forEach((stationData, stationId) => {
        const position = specialPositions[stationId] || stationPositions[stationId];
        if (!position) return;
        
        let labelSide = position.labelSide;
        if (stationData.lines.length > 1) {
          labelSide = 'center';
        }
        
        addStationUnique(
          position.x, 
          position.y, 
          stationId, 
          stationData.lines,
          stationData.nameHe, 
          labelSide
        );
      });
    }

    // ×¤×•× ×§×¦×™×™×ª ×¦×™×•×¨ ××¢×•×“×›× ×ª
    function drawMap() {
      // ×¦×™×•×¨ ×”×§×•×•×™×
      addPath(canadaMain.map(id => ({x:X.canadaMain,y:Y(row[id])})), lines.canada.color);
      addPath([ {x:X.canadaMain,y:Y(row['bridgeport'])}, ...canadaAir.map(id => ({x:X.canadaAir,y:Y(row[id])})) ], lines.canada.color);
      addPath([ {x:X.canadaMain,y:Y(row['bridgeport'])}, ...canadaRich.map(id => ({x:X.canadaRich,y:Y(row[id])})) ], lines.canada.color);

      addPath(expoMain.map(id => ({x:X.expoMain,y:Y(row[id])})), lines.expo.color);
      addPath([ {x:X.expoMain,y:Y(row['columbia'])}, ...['sapperton','braid','lougheed','production-way'].map(id => ({x:X.expoBranch,y:Y(row[id])})) ], lines.expo.color);

      addPath(milli.map(id => ({x:X.millennium,y:Y(row[id])})), lines.millennium.color);

      // ×—×™×‘×•×¨×™×
      link({x:X.canadaMain,y:Y(row['waterfront'])},{x:X.expoMain,y:Y(row['waterfront'])});
      link({x:X.expoMain,y:Y(row['commercial'])},{x:X.millennium,y:Y(row['commercial'])});
      link({x:X.expoBranch,y:Y(row['lougheed'])},{x:X.millennium,y:Y(row['lougheed'])});
      link({x:X.expoBranch,y:Y(row['production-way'])},{x:X.millennium,y:Y(row['production-way'])});
      link({x:X.canadaMain,y:Y(row['bridgeport'])},{x:X.canadaAir,y:Y(row['templeton'])});
      link({x:X.canadaMain,y:Y(row['bridgeport'])},{x:X.canadaRich,y:Y(row['aberdeen'])});

      // ×¦×™×•×¨ ×ª×—× ×•×ª ×™×™×—×•×“×™×•×ª
      drawUniqueStations();
    }

    // ××ª×—×•×œ ×”××¤×œ×™×§×¦×™×”
    window.addEventListener('load', () => {
      drawMap();
      renderLines();
    });
  </script>
</body>
</html>
